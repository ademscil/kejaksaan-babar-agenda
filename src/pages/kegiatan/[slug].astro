---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ActivityCard from '../../components/ActivityCard.astro';

export async function getStaticPaths() {
  const activities = await getCollection('activities', ({ data }) => data.status === 'Publish');
  return activities.map(activity => ({
    params: { slug: activity.slug },
    props: { activity },
  }));
}

const { activity } = Astro.props;
const { Content } = await activity.render();

const allActivities = await getCollection('activities', ({ data }) => data.status === 'Publish');
const relatedActivities = allActivities
  .filter(a => a.slug !== activity.slug && a.data.category === activity.data.category)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('id-ID', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  }).format(date);
};

const categoryColors: Record<string, string> = {
  'Pengajian': 'bg-emerald-100 text-emerald-700',
  'Penyuluhan Hukum': 'bg-blue-100 text-blue-700',
  'Kunjungan Kerja': 'bg-purple-100 text-purple-700',
  'Rapat Koordinasi': 'bg-orange-100 text-orange-700',
  'Upacara': 'bg-red-100 text-red-700',
  'Bakti Sosial': 'bg-pink-100 text-pink-700',
  'Lainnya': 'bg-gray-100 text-gray-700',
};
---

<BaseLayout 
  title={`${activity.data.title} - Aktivitas Kegiatan`}
  description={activity.data.excerpt}
  image={activity.data.coverImage}
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="mb-6">
      <a href="/kegiatan" class="text-primary-600 hover:text-primary-700 font-medium">
        ‚Üê Kembali ke Kegiatan
      </a>
    </div>

    <div class="mb-6">
      <span class={`inline-block px-4 py-2 rounded-xl text-sm font-medium ${categoryColors[activity.data.category] || categoryColors['Lainnya']}`}>
        {activity.data.category}
      </span>
    </div>

    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
      {activity.data.title}
    </h1>

    <div class="flex flex-wrap gap-4 text-gray-600 mb-8">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <time>{formatDate(activity.data.date)}</time>
      </div>
      {activity.data.location && (
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>{activity.data.location}</span>
        </div>
      )}
    </div>

    <div class="aspect-[16/9] rounded-3xl overflow-hidden mb-8 bg-gray-100">
      <img 
        src={activity.data.coverImage} 
        alt={activity.data.title}
        class="w-full h-full object-cover"
      />
    </div>

    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    {activity.data.tags && activity.data.tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-12">
        {activity.data.tags.map((tag: string) => (
          <span class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl text-sm">
            #{tag}
          </span>
        ))}
      </div>
    )}

    {activity.data.galleryImages && activity.data.galleryImages.length > 0 && (
      <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Galeri Foto</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="gallery">
          {activity.data.galleryImages.map((img: string, index: number) => (
            <button 
              class="gallery-item aspect-square rounded-2xl overflow-hidden bg-gray-100 hover:opacity-90 transition-opacity"
              data-index={index}
            >
              <img 
                src={img} 
                alt={`Foto ${index + 1}`}
                class="w-full h-full object-cover"
                loading="lazy"
              />
            </button>
          ))}
        </div>
      </div>
    )}
  </article>

  {relatedActivities.length > 0 && (
    <section class="bg-gray-50 py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">Kegiatan Terkait</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedActivities.map(related => (
            <ActivityCard
              title={related.data.title}
              date={related.data.date}
              category={related.data.category}
              excerpt={related.data.excerpt}
              coverImage={related.data.coverImage}
              slug={related.slug}
              tags={related.data.tags}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <div id="lightbox" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <button id="close-lightbox" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <button id="prev-image" class="absolute left-4 text-white hover:text-gray-300 z-10">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    <button id="next-image" class="absolute right-4 text-white hover:text-gray-300 z-10">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
    <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full object-contain" />
  </div>
</BaseLayout>

<style>
  .prose {
    @apply text-gray-700 leading-relaxed;
  }
  .prose h2 {
    @apply text-2xl font-bold text-gray-900 mt-8 mb-4;
  }
  .prose h3 {
    @apply text-xl font-bold text-gray-900 mt-6 mb-3;
  }
  .prose p {
    @apply mb-4;
  }
  .prose ul, .prose ol {
    @apply mb-4 ml-6;
  }
  .prose li {
    @apply mb-2;
  }
  .prose a {
    @apply text-primary-600 hover:text-primary-700 underline;
  }
</style>

<script is:inline define:vars={{ galleryImages: activity.data.galleryImages || [] }}>
  if (galleryImages.length > 0) {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const closeBtn = document.getElementById('close-lightbox');
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');
    const galleryItems = document.querySelectorAll('.gallery-item');

    let currentIndex = 0;

    function showImage(index) {
      currentIndex = index;
      if (lightboxImage) {
        lightboxImage.src = galleryImages[index];
      }
      if (lightbox) {
        lightbox.classList.remove('hidden');
      }
    }

    galleryItems.forEach((item, index) => {
      item.addEventListener('click', () => showImage(index));
    });

    closeBtn?.addEventListener('click', () => {
      lightbox?.classList.add('hidden');
    });

    prevBtn?.addEventListener('click', () => {
      currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
      showImage(currentIndex);
    });

    nextBtn?.addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % galleryImages.length;
      showImage(currentIndex);
    });

    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        lightbox.classList.add('hidden');
      }
    });
  }
</script>
